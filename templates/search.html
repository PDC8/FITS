<!-- search.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Search Closet - Digital Closet</title>
  <link rel="stylesheet" href="/static/base.css" />
  <link rel="stylesheet" href="/static/search.css" />
  <link href="https://fonts.googleapis.com/css2?family=Sour+Gummy:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>

<body>
  <header>
    <nav class="main-nav">
      <div class="nav-section left-links">
        <a href="/upload">Upload</a>
        <a href="/random-outfit">Generate</a>
      </div>
      <div class="logo">
        <a href="/">fits</a>
      </div>
      <div class="nav-section right-links">
        <a href="/search">Search</a>
        <a href="/friends">Friends</a>
        <a href="/logout">Profile</a>
      </div>
    </nav>
  </header>
  
  <div class="overlay"></div>
  <main class="search-container">
    <!-- Search and filter form -->
    <form class="search-form" action="/api/clothing" method="GET">
      <input type="text" id="item_name" name="item_name" placeholder="Search for T-Shirt" />
      <button class="filter-toggle" type="button">Show Filters â–¼</button>
      <div class="filters">
        <label class="filter_header" for="type_id">Type:</label>
        <div class="checkbox-grid">
          {% for type in types %}
            <label class="checkbox-square">
              <input type="checkbox" name="type_id" value="{{ type.type_id }}">
              <span>{{ type.type_name }}</span>
            </label>
          {% endfor %}
        </div>
  
        <label class="filter_header" for="brand_id">Brand:</label>
        <div class="checkbox-grid">
          {% for brand in brands %}
            <label class="checkbox-square">
              <input type="checkbox" name="brand_id" value="{{ brand.brand_id }}">
              <span>{{ brand.brand_name }}</span>
            </label>
          {% endfor %}
        </div>
        
        <label class="filter_header" for="size_id">Size:</label>
        <div class="checkbox-grid">
          {% for size in sizes %}
            <label class="checkbox-square">
              <input type="checkbox" name="size_id" value="{{ size.size_id }}">
              <span>{{ size.size_name }}</span>
            </label>
          {% endfor %}
        </div>     
  
        <label class="filter_header" for="color_id">Color:</label>
        <div class="checkbox-grid">
          {% for color in colors %}
            <label class="checkbox-square">
              <input type="checkbox" name="color_id" value="{{ color.color_id }}">
              <span>{{ color.color_name }}</span>
            </label>
          {% endfor %}
        </div>
  
        <label class="filter_header" for="fabric_id">Fabric:</label>
        <div class="checkbox-grid">
          {% for fabric in fabrics %}
            <label class="checkbox-square">
              <input type="checkbox" name="fabric_id" value="{{ fabric.fabric_id }}">
              <span>{{ fabric.fabric_name }}</span>
            </label>
          {% endfor %}
        </div>
        <button type="submit" id="clear-filters">Clear</button>
        <button type="submit" id="apply-filters">Apply</button>
      </div>
    </form>

    <!-- Results area -->
    <div class="search-results">
      <p class="placeholder">No items found yet. Try searching.</p>
    </div>
  </main>

  <script>
    // Function to send a DELETE request for an item and remove its card from the DOM on success.
    async function deleteItem(itemId, cardElement) {
      try {
        const response = await fetch(`/api/clothing/${itemId}`, {
          method: 'DELETE'
        });
        const result = await response.json();
        if (response.ok) {
          cardElement.remove();
        } else {
          alert(result.error || 'Failed to delete item.');
        }
      } catch (error) {
        console.error('Error deleting item:', error);
      }
    }

    // Function to render search results with delete buttons.
    function renderItems(items) {
      const resultsDiv = document.querySelector('.search-results');
      resultsDiv.innerHTML = '';
      
      if (items.length > 0) {
        items.forEach(item => {
          const itemCard = document.createElement('div');
          itemCard.className = 'item-card';
          itemCard.dataset.itemId = item.item_id;  // store the id on the card

          const imageContent = item.item_image 
            ? `<img src="data:image/png;base64,${item.item_image}" alt="${item.item_name}">`
            : '<div class="no-image">No Image Available</div>';

          itemCard.innerHTML = `
            <div class="item-image">${imageContent}</div>
            <h3 class="item-name">${item.item_name}</h3>
          `;
          
          // Create and append the delete button.
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'Delete';
          deleteBtn.className = 'delete-button';
          deleteBtn.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete this item?')) {
              deleteItem(item.item_id, itemCard);
            }
          });
          itemCard.appendChild(deleteBtn);
          
          resultsDiv.appendChild(itemCard);
        });
      } else {
        resultsDiv.innerHTML = '<p class="no-results">No items found matching your search</p>';
      }
    }

    // Function to load clothing items (either all or filtered)
    async function loadItems(event) {
      event.preventDefault();
      const formData = new URLSearchParams(new FormData(event.target));
      try {
        const response = await fetch(`/api/clothing?${formData}`);
        const items = await response.json();
        renderItems(items);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    // Attach event listener to the search form.
    document.querySelector('.search-form').addEventListener('submit', loadItems);

    // Additionally, listen for input changes on the search text field.
    document.querySelector('#item_name').addEventListener('input', async (e) => {
      const formData = new URLSearchParams(new FormData(document.querySelector('.search-form')));
      try {
        const response = await fetch(`/api/clothing?${formData}`);
        const items = await response.json();
        renderItems(items);
      } catch (error) {
        console.error('Error:', error);
      }
    });

    // Load all items on page load.
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch('/api/clothing');
        const items = await response.json();
        renderItems(items);
      } catch (error) {
        console.error('Error:', error);
      }
    });

    // Filter toggle functionality
    document.querySelector('.filter-toggle').addEventListener('click', () => {
      document.querySelector('.filters').classList.add('active');
      document.querySelector('.overlay').style.display = 'block';
      document.body.classList.add('overlay-active');
    });

    // Close filters when clicking overlay
    document.querySelector('.overlay').addEventListener('click', () => {
      document.querySelector('.filters').classList.remove('active');
      document.querySelector('.overlay').style.display = 'none';
      document.body.classList.remove('overlay-active');
    });

    // Update clear and apply buttons
    const applyButton = document.querySelector('#apply-filters');
    applyButton.addEventListener('click', () => {
      document.querySelector('.filters').classList.remove('active');
      document.querySelector('.overlay').style.display = 'none';
      document.body.classList.remove('overlay-active');
    });
    
    const clearButton = document.querySelector('#clear-filters');
    const filterInputs = document.querySelectorAll('.filters input[type="checkbox"]');
    clearButton.addEventListener('click', () => {
      filterInputs.forEach(input => input.checked = false);
      document.querySelector('.filters').classList.remove('active');
      document.querySelector('.overlay').style.display = 'none';
      document.body.classList.remove('overlay-active');
    });
  </script>
</body>
</html>
