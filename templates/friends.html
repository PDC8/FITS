<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Friends - Digital Closet</title>
  <link rel="stylesheet" href="/static/base.css"/>
  <link rel="stylesheet" href="/static/friends.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Sour+Gummy:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>
  <header>
    <nav class="main-nav">
      <div class="nav-section left-links">
        <a href="/upload">Upload</a>
        <a href="/random-outfit">Generate</a>
      </div>
      <div class="logo">
        <img src="/static/logo.png" alt="Logo">
    </div>
      <div class="nav-section right-links">
        <a href="/search">Search</a>
        <a href="/friends">Friends</a>
        <a href="/logout">Profile</a>
      </div>
    </nav>
  </header>
  <main>
    <div class="dropdown">
        <button class="dropbtn">Requests ▾</button>
        <div class="dropdown-content" id="requests-dropdown"></div>
    </div>
    <div class="dropdown">
        <button class="dropbtn">Friends ▾</button>
        <div class="dropdown-content" id="friends-dropdown"></div>
    </div>  
    <div class="dropdown">
      <button class="dropbtn">Add Friend ▾</button>
      <div class="dropdown-content">
        <input type="text" id="friend-netid-input" placeholder="Enter friend's netid">
        <button id="add-friend-btn">Add</button>
      </div>
    </div>
    <div id="friends-list"></div>
  </main>
  <script>
    async function fetchJSON(u,opts){let r=await fetch(u,opts);return r.json();}
    async function loadFriends(){
      const fs=await fetchJSON('/api/friends');
      const el=document.getElementById('friends-list');
      el.innerHTML='<h2>Your Friends</h2>';
      fs.forEach(x=>{let d=document.createElement('div');d.textContent=x.netid;el.appendChild(d);});
    }
    async function loadOutfits(){
      const os=await fetchJSON('/api/friends/outfits');
      const dd=document.getElementById('outfits-dropdown');
      dd.innerHTML='';
      os.forEach(o=>{
        let c=document.createElement('div');
        c.className='friend-outfit';
        let s=document.createElement('strong');
        s.textContent=o.outfit_name;
        c.appendChild(s);
        o.items.forEach(i=>{
          let img=document.createElement('img');
          img.src='data:image/png;base64,'+i.item_image;
          c.appendChild(img);
        });
        dd.appendChild(c);
      });
    }
    async function loadRequests(){
        const rs = await fetchJSON('/api/friend-requests');
        const dd = document.getElementById('requests-dropdown');
        dd.innerHTML = '';
        rs.forEach(r => {
            const row = document.createElement('div');
            row.style.display = 'flex';
            row.style.justifyContent = 'space-between';
            row.style.marginBottom = '0.5rem';
            row.innerHTML = `<span>${r.netid}</span>
                            <button data-id="${r.requester_id}">Accept</button>`;
            row.querySelector('button').onclick = async () => {
            await fetchJSON('/api/friends/accept', {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({requester_id: r.requester_id})
            });
            loadRequests();
            loadFriends();
            };
            dd.appendChild(row);
        });
    }
    async function loadFriendsDropdown(){
        const fs = await fetchJSON('/api/friends');
        const dd = document.getElementById('friends-dropdown');
        dd.innerHTML = '';
        fs.forEach(f => {
            const a = document.createElement('a');
            a.href = `/friends/${f.user_id}`;
            a.textContent = f.netid;
            a.style.display = 'block';
            a.style.padding = '0.5rem';
            dd.appendChild(a);
        });
    }
    document.getElementById('add-friend-btn').onclick=async()=>{
      let n=document.getElementById('friend-netid-input').value.trim();
      if(!n) return;
      let us=await fetchJSON('/api/users');
      let u=us.find(x=>x.netid===n);
      if(!u){alert('User not found');return;}
      await fetchJSON('/api/friends',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({friend_id:u.user_id})
      });
      document.getElementById('friend-netid-input').value='';
      loadFriends();loadOutfits();
    };
    window.onload = () => {
        loadRequests();
        loadFriends();
        loadFriendsDropdown();
    };
  </script>
</body>
</html>
